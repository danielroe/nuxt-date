<script setup lang='ts'>
import { computed, getCurrentInstance, useNuxtApp, useHead } from '#imports'

const props = withDefaults(defineProps<{
  locale?: string
  datetime: string | number | Date
  localeMatcher?: 'best fit' | 'lookup'
  weekday?: 'long' | 'short' | 'narrow'
  era?: 'long' | 'short' | 'narrow'
  year?: 'numeric' | '2-digit'
  month?: 'numeric' | '2-digit' | 'long' | 'short' | 'narrow'
  day?: 'numeric' | '2-digit'
  hour?: 'numeric' | '2-digit'
  minute?: 'numeric' | '2-digit'
  second?: 'numeric' | '2-digit'
  timeZoneName?: 'short' | 'long' | 'shortOffset' | 'longOffset' | 'shortGeneric' | 'longGeneric'
  formatMatcher?: 'best fit' | 'basic'
  hour12?: boolean
  timeZone?: string

  calendar?: string
  dayPeriod?: 'narrow' | 'short' | 'long'
  numberingSystem?: string

  dateStyle?: 'full' | 'long' | 'medium' | 'short'
  timeStyle?: 'full' | 'long' | 'medium' | 'short'
  hourCycle?: 'h11' | 'h12' | 'h23' | 'h24'
}>(), {
  hour12: undefined
})

const renderedDate = getCurrentInstance()?.vnode.el?.getAttribute('datetime')
const locale = getCurrentInstance()?.vnode.el?.getAttribute('data-locale')

const nuxtApp = useNuxtApp()

const date = computed(() => {
  if (renderedDate && !nuxtApp.isHydrated) return new Date(renderedDate)
  if (!props.datetime) return new Date()
  return new Date(props.datetime)
})

const formatter = computed(() => {
  return new Intl.DateTimeFormat(locale ?? props.locale, {
    localeMatcher: props.localeMatcher,
    weekday: props.weekday,
    era: props.era,
    year: props.year,
    month: props.month,
    day: props.day,
    hour: props.hour,
    minute: props.minute,
    second: props.second,
    timeZoneName: props.timeZoneName,
    formatMatcher: props.formatMatcher,
    hour12: props.hour12,
    timeZone: props.timeZone,
    calendar: props.calendar,
    dayPeriod: props.dayPeriod,
    numberingSystem: props.numberingSystem,
    dateStyle: props.dateStyle,
    timeStyle: props.timeStyle,
    hourCycle: props.hourCycle,
  })
})
const formattedDate = computed(() => formatter.value.format(date.value))
const isoDate = computed(() => date.value.toISOString())

const dataset: Record<string, any> = {}

if (process.server) {
  for (const prop in props) {
    if (prop !== 'datetime') {
      dataset[`data-${prop}`] = props?.[prop as keyof typeof props]
    }
  }
  useHead({
    script: [{
      tagPosition: 'bodyClose',
      key: 'nuxt-time',
      innerHTML: `
        document.querySelectorAll('[data-n-time]').forEach(el => {
          const date = new Date(el.getAttribute('datetime'));
          const options = {};
          for (const name of el.getAttributeNames()) {
            if (name.startsWith('data-')) {
              options[name.slice(5)] = el.getAttribute(name);
            }
          }

          const formatter = new Intl.DateTimeFormat(options.locale, options);
          el.textContent = formatter.format(date)
        })
      `.replace(/\s+/g, ' ')
    }]
  })
}
</script>

<template>
  <time data-n-time v-bind="dataset" :datetime="isoDate" >{{ formattedDate }}</time>
</template>
